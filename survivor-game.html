<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æš—å¤œå¹¸å­˜è€… - å¼€å‘è°ƒè¯•ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            overflow-x: hidden;
        }

        .container {
            display: flex;
            height: 100vh;
            gap: 20px;
            padding: 20px;
        }

        .game-section {
            flex: 2;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .debug-section {
            flex: 1;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 15px;
            padding: 20px;
            overflow-y: auto;
            max-height: 100vh;
        }

        .game-title {
            text-align: center;
            font-size: 2rem;
            margin-bottom: 10px;
            color: #FFD700;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }

        #survivorCanvas {
            border: 3px solid #FFD700;
            border-radius: 10px;
            background: #001122;
            display: block;
            margin: 0 auto;
            max-width: 100%;
            height: auto;
        }

        .game-ui {
            background: rgba(0, 0, 0, 0.5);
            border-radius: 10px;
            padding: 15px;
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: center;
        }

        .game-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat {
            text-align: center;
            background: rgba(255, 255, 255, 0.1);
            padding: 8px 12px;
            border-radius: 8px;
        }

        .stat-value {
            font-size: 1.2rem;
            font-weight: bold;
            color: #FFD700;
        }

        .stat-label {
            font-size: 0.8rem;
            opacity: 0.8;
        }

        .health-bar, .exp-bar {
            width: 150px;
            height: 15px;
            background: #333;
            border-radius: 8px;
            overflow: hidden;
            margin: 5px 0;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444, #ff6666);
            transition: width 0.3s ease;
        }

        .exp-fill {
            height: 100%;
            background: linear-gradient(90deg, #44ff44, #66ff66);
            transition: width 0.3s ease;
        }

        .game-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .game-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            font-size: 0.9rem;
        }

        .game-btn.start {
            background: #4CAF50;
            color: white;
        }

        .game-btn.pause {
            background: #ff9800;
            color: white;
        }

        .game-btn.restart {
            background: #f44336;
            color: white;
        }

        .game-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .debug-title {
            font-size: 1.3rem;
            margin-bottom: 15px;
            color: #FFD700;
            border-bottom: 2px solid #FFD700;
            padding-bottom: 5px;
        }

        .param-group {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
        }

        .param-group h4 {
            color: #87CEEB;
            margin-bottom: 10px;
            font-size: 1.1rem;
        }

        .param-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .param-label {
            flex: 1;
            font-size: 0.9rem;
        }

        .param-input {
            width: 80px;
            padding: 4px 8px;
            border: 1px solid #555;
            border-radius: 4px;
            background: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 0.9rem;
        }

        .param-input:focus {
            outline: none;
            border-color: #FFD700;
        }

        .apply-btn {
            background: #FFD700;
            color: #000;
            border: none;
            padding: 8px 16px;
            border-radius: 5px;
            cursor: pointer;
            font-weight: bold;
            width: 100%;
            margin-top: 10px;
        }

        .apply-btn:hover {
            background: #FFA500;
        }

        .upgrade-panel {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.9);
            padding: 2rem;
            border-radius: 15px;
            border: 2px solid #FFD700;
            z-index: 3000;
            min-width: 400px;
        }

        .upgrade-options {
            display: grid;
            gap: 1rem;
            margin-top: 1rem;
        }

        .upgrade-option {
            padding: 1rem;
            border: 2px solid #FFD700;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.1);
        }

        .upgrade-option:hover {
            background: #FFD700;
            color: #000;
            transform: scale(1.02);
        }

        .upgrade-title {
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .upgrade-description {
            font-size: 0.9rem;
            opacity: 0.8;
        }

        .instructions {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        @media (max-width: 1200px) {
            .container {
                flex-direction: column;
                height: auto;
            }
            
            .debug-section {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- æ¸¸æˆåŒºåŸŸ -->
        <div class="game-section">
            <h1 class="game-title">ğŸ§›â€â™‚ï¸ æš—å¤œå¹¸å­˜è€… - å¼€å‘è°ƒè¯•ç‰ˆ</h1>
            
            <canvas id="survivorCanvas" width="800" height="600"></canvas>
            
            <div class="game-ui">
                <div class="game-stats">
                    <div class="stat">
                        <div class="stat-value" id="level">1</div>
                        <div class="stat-label">ç­‰çº§</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="score">0</div>
                        <div class="stat-label">åˆ†æ•°</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="kills">0</div>
                        <div class="stat-label">å‡»æ€</div>
                    </div>
                    <div class="stat">
                        <div class="stat-value" id="time">0:00</div>
                        <div class="stat-label">æ—¶é—´</div>
                    </div>
                </div>
                
                <div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span>è¡€é‡:</span>
                        <div class="health-bar">
                            <div class="health-fill" id="healthFill" style="width: 100%;"></div>
                        </div>
                    </div>
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <span>ç»éªŒ:</span>
                        <div class="exp-bar">
                            <div class="exp-fill" id="expFill" style="width: 0%;"></div>
                        </div>
                    </div>
                </div>
                
                <div class="game-controls">
                    <button class="game-btn start" onclick="startSurvivorGame()">å¼€å§‹æ¸¸æˆ</button>
                    <button class="game-btn pause" onclick="pauseSurvivorGame()">æš‚åœ</button>
                    <button class="game-btn restart" onclick="restartSurvivorGame()">é‡æ–°å¼€å§‹</button>
                </div>
            </div>
            
            <div style="text-align: center; font-size: 0.9rem; opacity: 0.8;">
                ä½¿ç”¨ WASD æˆ–æ–¹å‘é”®ç§»åŠ¨ï¼Œè‡ªåŠ¨æ”»å‡»æœ€è¿‘çš„æ•Œäºº
            </div>
        </div>

        <!-- è°ƒè¯•é¢æ¿ -->
        <div class="debug-section">
            <h2 class="debug-title">ğŸ› ï¸ å®æ—¶è°ƒè¯•é¢æ¿</h2>
            
            <div class="instructions">
                <strong>ä½¿ç”¨è¯´æ˜ï¼š</strong><br>
                â€¢ ä¿®æ”¹å‚æ•°åç‚¹å‡»"åº”ç”¨æ›´æ”¹"ç«‹å³ç”Ÿæ•ˆ<br>
                â€¢ æ¸¸æˆè¿è¡Œä¸­å¯å®æ—¶è°ƒæ•´æ‰€æœ‰å‚æ•°<br>
                â€¢ å‚æ•°ä¼šç«‹å³å½±å“æ–°ç”Ÿæˆçš„æ•Œäººå’Œç°æœ‰æ¸¸æˆå¯¹è±¡
            </div>

            <!-- ç©å®¶å‚æ•° -->
            <div class="param-group">
                <h4>ğŸ‘¤ ç©å®¶å‚æ•°</h4>
                <div class="param-item">
                    <span class="param-label">ç§»åŠ¨é€Ÿåº¦</span>
                    <input type="number" class="param-input" id="playerSpeed" value="2.2" step="0.1" min="0.1">
                </div>
                <div class="param-item">
                    <span class="param-label">æœ€å¤§è¡€é‡</span>
                    <input type="number" class="param-input" id="playerMaxHealth" value="100" step="5" min="10">
                </div>
                <div class="param-item">
                    <span class="param-label">å‡çº§æ‰€éœ€ç»éªŒ</span>
                    <input type="number" class="param-input" id="expToNext" value="100" step="10" min="10">
                </div>
                <button class="apply-btn" onclick="applyPlayerParams()">åº”ç”¨ç©å®¶å‚æ•°</button>
            </div>

            <!-- æ•Œäººç”Ÿæˆå‚æ•° -->
            <div class="param-group">
                <h4>ğŸ‘¹ æ•Œäººç”Ÿæˆ</h4>
                <div class="param-item">
                    <span class="param-label">åˆå§‹ç”Ÿæˆç‡</span>
                    <input type="number" class="param-input" id="spawnRateBase" value="0.005" step="0.001" min="0.001">
                </div>
                <div class="param-item">
                    <span class="param-label">ç”Ÿæˆç‡å¢é•¿</span>
                    <input type="number" class="param-input" id="spawnRateGrowth" value="0.0002" step="0.0001" min="0">
                </div>
                <div class="param-item">
                    <span class="param-label">æœ€å¤§ç”Ÿæˆç‡</span>
                    <input type="number" class="param-input" id="spawnRateMax" value="0.025" step="0.005" min="0.005">
                </div>
                <button class="apply-btn" onclick="applySpawnParams()">åº”ç”¨ç”Ÿæˆå‚æ•°</button>
            </div>

            <!-- æš—å½±è™è å‚æ•° -->
            <div class="param-group">
                <h4>ğŸ¦‡ æš—å½±è™è </h4>
                <div class="param-item">
                    <span class="param-label">è¡€é‡</span>
                    <input type="number" class="param-input" id="batHealth" value="25" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">ç§»åŠ¨é€Ÿåº¦</span>
                    <input type="number" class="param-input" id="batSpeed" value="1.0" step="0.1" min="0.1">
                </div>
                <div class="param-item">
                    <span class="param-label">æ”»å‡»ä¼¤å®³</span>
                    <input type="number" class="param-input" id="batDamage" value="8" step="1" min="1">
                </div>
                <div class="param-item">
                    <span class="param-label">ç»éªŒå€¼</span>
                    <input type="number" class="param-input" id="batExp" value="5" step="1" min="1">
                </div>
                <button class="apply-btn" onclick="applyBatParams()">åº”ç”¨è™è å‚æ•°</button>
            </div>

            <!-- éª·é«…æˆ˜å£«å‚æ•° -->
            <div class="param-group">
                <h4>ğŸ’€ éª·é«…æˆ˜å£«</h4>
                <div class="param-item">
                    <span class="param-label">è¡€é‡</span>
                    <input type="number" class="param-input" id="skeletonHealth" value="50" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">ç§»åŠ¨é€Ÿåº¦</span>
                    <input type="number" class="param-input" id="skeletonSpeed" value="0.7" step="0.1" min="0.1">
                </div>
                <div class="param-item">
                    <span class="param-label">æ”»å‡»ä¼¤å®³</span>
                    <input type="number" class="param-input" id="skeletonDamage" value="15" step="1" min="1">
                </div>
                <div class="param-item">
                    <span class="param-label">ç»éªŒå€¼</span>
                    <input type="number" class="param-input" id="skeletonExp" value="10" step="1" min="1">
                </div>
                <button class="apply-btn" onclick="applySkeletonParams()">åº”ç”¨éª·é«…å‚æ•°</button>
            </div>

            <!-- æš—é»‘æ³•å¸ˆå‚æ•° -->
            <div class="param-group">
                <h4>ğŸ§™â€â™‚ï¸ æš—é»‘æ³•å¸ˆ</h4>
                <div class="param-item">
                    <span class="param-label">è¡€é‡</span>
                    <input type="number" class="param-input" id="mageHealth" value="35" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">ç§»åŠ¨é€Ÿåº¦</span>
                    <input type="number" class="param-input" id="mageSpeed" value="0.5" step="0.1" min="0.1">
                </div>
                <div class="param-item">
                    <span class="param-label">æ”»å‡»ä¼¤å®³</span>
                    <input type="number" class="param-input" id="mageDamage" value="12" step="1" min="1">
                </div>
                <div class="param-item">
                    <span class="param-label">ç»éªŒå€¼</span>
                    <input type="number" class="param-input" id="mageExp" value="15" step="1" min="1">
                </div>
                <button class="apply-btn" onclick="applyMageParams()">åº”ç”¨æ³•å¸ˆå‚æ•°</button>
            </div>

            <!-- æ­¦å™¨å‚æ•° -->
            <div class="param-group">
                <h4>âš”ï¸ é­”æ³•é£å¼¹</h4>
                <div class="param-item">
                    <span class="param-label">ä¼¤å®³</span>
                    <input type="number" class="param-input" id="weaponDamage" value="20" step="1" min="1">
                </div>
                <div class="param-item">
                    <span class="param-label">æ”»å‡»é€Ÿåº¦(ms)</span>
                    <input type="number" class="param-input" id="weaponCooldown" value="800" step="50" min="50">
                </div>
                <div class="param-item">
                    <span class="param-label">å°„ç¨‹</span>
                    <input type="number" class="param-input" id="weaponRange" value="250" step="10" min="50">
                </div>
                <div class="param-item">
                    <span class="param-label">å­å¼¹é€Ÿåº¦</span>
                    <input type="number" class="param-input" id="weaponSpeed" value="6" step="0.5" min="1">
                </div>
                <button class="apply-btn" onclick="applyWeaponParams()">åº”ç”¨æ­¦å™¨å‚æ•°</button>
            </div>

            <!-- å‡çº§ç³»æ•° -->
            <div class="param-group">
                <h4>ğŸ“ˆ å‡çº§ç³»æ•°</h4>
                <div class="param-item">
                    <span class="param-label">ä¼¤å®³æå‡(%)</span>
                    <input type="number" class="param-input" id="damageUpgrade" value="25" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">æ”»é€Ÿæå‡(%)</span>
                    <input type="number" class="param-input" id="speedUpgrade" value="30" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">è¡€é‡å¢åŠ </span>
                    <input type="number" class="param-input" id="healthUpgrade" value="30" step="5" min="5">
                </div>
                <div class="param-item">
                    <span class="param-label">ç§»é€Ÿæå‡(%)</span>
                    <input type="number" class="param-input" id="moveUpgrade" value="30" step="5" min="5">
                </div>
                <button class="apply-btn" onclick="applyUpgradeParams()">åº”ç”¨å‡çº§ç³»æ•°</button>
            </div>

            <!-- å¿«é€Ÿè°ƒè¯•æŒ‰é’® -->
            <div class="param-group">
                <h4>ğŸš€ å¿«é€Ÿè°ƒè¯•</h4>
                <button class="apply-btn" onclick="setEasyMode()" style="background: #4CAF50; margin-bottom: 5px;">ç®€å•æ¨¡å¼</button>
                <button class="apply-btn" onclick="setNormalMode()" style="background: #FF9800; margin-bottom: 5px;">æ™®é€šæ¨¡å¼</button>
                <button class="apply-btn" onclick="setHardMode()" style="background: #F44336; margin-bottom: 5px;">å›°éš¾æ¨¡å¼</button>
                <button class="apply-btn" onclick="setTestMode()" style="background: #9C27B0;">æµ‹è¯•æ¨¡å¼</button>
            </div>
        </div>
    </div>

    <!-- å‡çº§é¢æ¿ -->
    <div id="upgradePanel" class="upgrade-panel">
        <h3 style="color: #FFD700;">é€‰æ‹©å‡çº§</h3>
        <div class="upgrade-options" id="upgradeOptions">
            <!-- å‡çº§é€‰é¡¹å°†åœ¨è¿™é‡Œç”Ÿæˆ -->
        </div>
    </div>

    <script>
        // å¸è¡€é¬¼å¹¸å­˜è€…æ¸¸æˆé€»è¾‘
        let survivorGame = {
            canvas: null,
            ctx: null,
            running: false,
            paused: false,
            lastTime: 0,
            
            // ç©å®¶
            player: {
                x: 400,
                y: 300,
                radius: 15,
                health: 100,
                maxHealth: 100,
                speed: 2.2,
                exp: 0,
                level: 1,
                expToNext: 100
            },
            
            // æ¸¸æˆçŠ¶æ€
            score: 0,
            kills: 0,
            startTime: 0,
            
            // æ¸¸æˆå¯¹è±¡
            enemies: [],
            projectiles: [],
            particles: [],
            pickups: [],
            
            // å¯è°ƒè¯•å‚æ•°
            params: {
                spawnRateBase: 0.005,
                spawnRateGrowth: 0.0002,
                spawnRateMax: 0.025,
                damageUpgradePercent: 25,
                speedUpgradePercent: 30,
                healthUpgradeAmount: 30,
                moveUpgradePercent: 30
            },
            
            // æ­¦å™¨ç³»ç»Ÿ
            weapons: [
                {
                    name: 'é­”æ³•é£å¼¹',
                    damage: 20,
                    speed: 6,
                    cooldown: 800,
                    lastFire: 0,
                    level: 1,
                    range: 250,
                    color: '#FFD700',
                    type: 'projectile'
                }
            ],
            
            // å¯è§£é”æ­¦å™¨
            availableWeapons: [
                {
                    name: 'ç«çƒæœ¯',
                    damage: 40,
                    speed: 4,
                    cooldown: 1500,
                    range: 200,
                    color: '#FF4500',
                    type: 'projectile',
                    effect: 'explosion'
                },
                {
                    name: 'å†°éœœç®­',
                    damage: 15,
                    speed: 8,
                    cooldown: 600,
                    range: 300,
                    color: '#87CEEB',
                    type: 'projectile',
                    effect: 'slow'
                },
                {
                    name: 'é›·ç”µé“¾',
                    damage: 30,
                    speed: 0,
                    cooldown: 2000,
                    range: 150,
                    color: '#FFFF00',
                    type: 'chain',
                    chainCount: 3
                },
                {
                    name: 'æ—‹è½¬åˆ€åˆƒ',
                    damage: 25,
                    speed: 5,
                    cooldown: 100,
                    range: 80,
                    color: '#C0C0C0',
                    type: 'orbit'
                },
                {
                    name: 'æ²»ç–—å…‰ç¯',
                    damage: 0,
                    speed: 0,
                    cooldown: 3000,
                    range: 100,
                    color: '#90EE90',
                    type: 'heal',
                    healAmount: 30
                }
            ],
            
            // æ•Œäººç±»å‹
            enemyTypes: [
                {
                    name: 'æš—å½±è™è ',
                    health: 25,
                    speed: 1.0,
                    damage: 8,
                    exp: 5,
                    color: '#8B4513',
                    radius: 8
                },
                {
                    name: 'éª·é«…æˆ˜å£«',
                    health: 50,
                    speed: 0.7,
                    damage: 15,
                    exp: 10,
                    color: '#DDDDDD',
                    radius: 12
                },
                {
                    name: 'æš—é»‘æ³•å¸ˆ',
                    health: 35,
                    speed: 0.5,
                    damage: 12,
                    exp: 15,
                    color: '#4B0082',
                    radius: 10
                }
            ],
            
            // å‡çº§é€‰é¡¹
            upgrades: [
                {
                    name: 'å¢åŠ ä¼¤å®³',
                    description: 'æ­¦å™¨ä¼¤å®³ +25%',
                    apply: () => {
                        const percent = survivorGame.params.damageUpgradePercent;
                        survivorGame.weapons.forEach(w => w.damage = Math.floor(w.damage * (1 + percent/100)));
                    }
                },
                {
                    name: 'æå‡æ”»é€Ÿ',
                    description: 'æ”»å‡»é€Ÿåº¦ +30%',
                    apply: () => {
                        const percent = survivorGame.params.speedUpgradePercent;
                        survivorGame.weapons.forEach(w => w.cooldown = Math.floor(w.cooldown * (1 - percent/100)));
                    }
                },
                {
                    name: 'å¢åŠ è¡€é‡',
                    description: 'æœ€å¤§è¡€é‡ +30',
                    apply: () => {
                        const amount = survivorGame.params.healthUpgradeAmount;
                        survivorGame.player.maxHealth += amount;
                        survivorGame.player.health = survivorGame.player.maxHealth;
                    }
                },
                {
                    name: 'ç§»åŠ¨åŠ é€Ÿ',
                    description: 'ç§»åŠ¨é€Ÿåº¦ +30%',
                    apply: () => {
                        const percent = survivorGame.params.moveUpgradePercent;
                        survivorGame.player.speed *= (1 + percent/100);
                    }
                },
                {
                    name: 'å°„ç¨‹å»¶é•¿',
                    description: 'æ­¦å™¨å°„ç¨‹ +40%',
                    apply: () => {
                        survivorGame.weapons.forEach(w => w.range = Math.floor(w.range * 1.4));
                    }
                },
                {
                    name: 'ç”Ÿå‘½æ¢å¤',
                    description: 'æ¯ç§’æ¢å¤ 3 ç‚¹ç”Ÿå‘½å€¼',
                    apply: () => {
                        survivorGame.hasHealthRegen = true;
                        survivorGame.healthRegenRate = (survivorGame.healthRegenRate || 0) + 3;
                    }
                },
                {
                    name: 'è·å¾—æ–°æ­¦å™¨: ç«çƒæœ¯',
                    description: 'è§£é”ç«çƒæœ¯ï¼Œé€ æˆçˆ†ç‚¸ä¼¤å®³',
                    condition: () => !survivorGame.weapons.find(w => w.name === 'ç«çƒæœ¯'),
                    apply: () => {
                        const fireball = {...survivorGame.availableWeapons.find(w => w.name === 'ç«çƒæœ¯')};
                        fireball.lastFire = 0;
                        survivorGame.weapons.push(fireball);
                    }
                },
                {
                    name: 'è·å¾—æ–°æ­¦å™¨: å†°éœœç®­',
                    description: 'è§£é”å†°éœœç®­ï¼Œå‡ç¼“æ•Œäººé€Ÿåº¦',
                    condition: () => !survivorGame.weapons.find(w => w.name === 'å†°éœœç®­'),
                    apply: () => {
                        const frostArrow = {...survivorGame.availableWeapons.find(w => w.name === 'å†°éœœç®­')};
                        frostArrow.lastFire = 0;
                        survivorGame.weapons.push(frostArrow);
                    }
                },
                {
                    name: 'è·å¾—æ–°æ­¦å™¨: é›·ç”µé“¾',
                    description: 'è§£é”é›·ç”µé“¾ï¼Œå¯è¿é”æ”»å‡»',
                    condition: () => !survivorGame.weapons.find(w => w.name === 'é›·ç”µé“¾'),
                    apply: () => {
                        const lightning = {...survivorGame.availableWeapons.find(w => w.name === 'é›·ç”µé“¾')};
                        lightning.lastFire = 0;
                        survivorGame.weapons.push(lightning);
                    }
                },
                {
                    name: 'è·å¾—æ–°æ­¦å™¨: æ—‹è½¬åˆ€åˆƒ',
                    description: 'è§£é”æ—‹è½¬åˆ€åˆƒï¼Œå›´ç»•è§’è‰²æ—‹è½¬',
                    condition: () => !survivorGame.weapons.find(w => w.name === 'æ—‹è½¬åˆ€åˆƒ'),
                    apply: () => {
                        const blade = {...survivorGame.availableWeapons.find(w => w.name === 'æ—‹è½¬åˆ€åˆƒ')};
                        blade.lastFire = 0;
                        blade.angle = 0;
                        survivorGame.weapons.push(blade);
                    }
                },
                {
                    name: 'è·å¾—æ–°æ­¦å™¨: æ²»ç–—å…‰ç¯',
                    description: 'è§£é”æ²»ç–—å…‰ç¯ï¼Œå®šæœŸæ¢å¤ç”Ÿå‘½',
                    condition: () => !survivorGame.weapons.find(w => w.name === 'æ²»ç–—å…‰ç¯'),
                    apply: () => {
                        const heal = {...survivorGame.availableWeapons.find(w => w.name === 'æ²»ç–—å…‰ç¯')};
                        heal.lastFire = 0;
                        survivorGame.weapons.push(heal);
                    }
                },
                {
                    name: 'æ­¦å™¨è¿›åŒ–',
                    description: 'éšæœºå‡çº§ä¸€ä¸ªæ­¦å™¨',
                    condition: () => survivorGame.weapons.length > 1,
                    apply: () => {
                        const weapon = survivorGame.weapons[Math.floor(Math.random() * survivorGame.weapons.length)];
                        weapon.damage = Math.floor(weapon.damage * 1.5);
                        weapon.range = Math.floor(weapon.range * 1.2);
                        if (weapon.cooldown > 100) weapon.cooldown = Math.floor(weapon.cooldown * 0.8);
                    }
                }
            ]
        };

        // åˆå§‹åŒ–æ¸¸æˆ
        function initSurvivorGame() {
            survivorGame.canvas = document.getElementById('survivorCanvas');
            survivorGame.ctx = survivorGame.canvas.getContext('2d');
            
            // é”®ç›˜æ§åˆ¶
            survivorGame.keys = {};
            document.addEventListener('keydown', (e) => {
                survivorGame.keys[e.key.toLowerCase()] = true;
            });
            document.addEventListener('keyup', (e) => {
                survivorGame.keys[e.key.toLowerCase()] = false;
            });
        }

        function startSurvivorGame() {
            if (survivorGame.running) return;
            
            survivorGame.running = true;
            survivorGame.paused = false;
            survivorGame.startTime = Date.now();
            survivorGame.lastTime = 0;
            
            // é‡ç½®æ¸¸æˆçŠ¶æ€
            survivorGame.player = {
                x: 400,
                y: 300,
                radius: 15,
                health: parseInt(document.getElementById('playerMaxHealth').value),
                maxHealth: parseInt(document.getElementById('playerMaxHealth').value),
                speed: parseFloat(document.getElementById('playerSpeed').value),
                exp: 0,
                level: 1,
                expToNext: parseInt(document.getElementById('expToNext').value)
            };
            
            survivorGame.score = 0;
            survivorGame.kills = 0;
            survivorGame.enemies = [];
            survivorGame.projectiles = [];
            survivorGame.particles = [];
            survivorGame.pickups = [];
            survivorGame.hasHealthRegen = false;
            
            // é‡ç½®æ­¦å™¨
            survivorGame.weapons = [
                {
                    name: 'é­”æ³•é£å¼¹',
                    damage: parseInt(document.getElementById('weaponDamage').value),
                    speed: parseFloat(document.getElementById('weaponSpeed').value),
                    cooldown: parseInt(document.getElementById('weaponCooldown').value),
                    lastFire: 0,
                    level: 1,
                    range: parseInt(document.getElementById('weaponRange').value),
                    color: '#FFD700',
                    type: 'projectile'
                }
            ];
            
            gameLoop();
        }

        function pauseSurvivorGame() {
            survivorGame.paused = !survivorGame.paused;
        }

        function restartSurvivorGame() {
            survivorGame.running = false;
            survivorGame.paused = false;
            startSurvivorGame();
        }

        function gameLoop(currentTime = 0) {
            if (!survivorGame.running) return;
            
            const deltaTime = currentTime - survivorGame.lastTime;
            survivorGame.lastTime = currentTime;
            
            if (!survivorGame.paused) {
                updateGame(deltaTime);
            }
            
            renderGame();
            updateUI();
            
            requestAnimationFrame(gameLoop);
        }

        function updateGame(deltaTime) {
            // æ›´æ–°ç©å®¶ä½ç½®
            updatePlayer();
            
            // ç”Ÿæˆæ•Œäºº
            spawnEnemies();
            
            // æ›´æ–°æ•Œäºº
            updateEnemies(deltaTime);
            
            // æ›´æ–°æ­¦å™¨å’Œå°„å‡»
            updateWeapons(deltaTime);
            
            // æ›´æ–°å­å¼¹
            updateProjectiles(deltaTime);
            
            // æ›´æ–°ç²’å­æ•ˆæœ
            updateParticles(deltaTime);
            
            // æ›´æ–°æ‹¾å–ç‰©
            updatePickups(deltaTime);
            
            // æ£€æŸ¥ç¢°æ’
            checkCollisions();
            
            // ç”Ÿå‘½æ¢å¤
            if (survivorGame.hasHealthRegen) {
                const regenRate = survivorGame.healthRegenRate || 2;
                survivorGame.player.health = Math.min(
                    survivorGame.player.maxHealth,
                    survivorGame.player.health + deltaTime * 0.001 * regenRate
                );
            }
            
            // æ£€æŸ¥æ¸¸æˆç»“æŸ
            if (survivorGame.player.health <= 0) {
                gameOver();
            }
        }

        function updatePlayer() {
            const player = survivorGame.player;
            
            // ç§»åŠ¨æ§åˆ¶
            if (survivorGame.keys['w'] || survivorGame.keys['arrowup']) {
                player.y = Math.max(player.radius, player.y - player.speed);
            }
            if (survivorGame.keys['s'] || survivorGame.keys['arrowdown']) {
                player.y = Math.min(survivorGame.canvas.height - player.radius, player.y + player.speed);
            }
            if (survivorGame.keys['a'] || survivorGame.keys['arrowleft']) {
                player.x = Math.max(player.radius, player.x - player.speed);
            }
            if (survivorGame.keys['d'] || survivorGame.keys['arrowright']) {
                player.x = Math.min(survivorGame.canvas.width - player.radius, player.x + player.speed);
            }
        }

        function spawnEnemies() {
            // æ ¹æ®æ—¶é—´å’Œè°ƒè¯•å‚æ•°å¢åŠ æ•Œäººç”Ÿæˆé¢‘ç‡
            const gameTime = (Date.now() - survivorGame.startTime) / 1000;
            const spawnRate = Math.min(
                survivorGame.params.spawnRateBase + gameTime * survivorGame.params.spawnRateGrowth, 
                survivorGame.params.spawnRateMax
            );
            
            if (Math.random() < spawnRate) {
                const side = Math.floor(Math.random() * 4);
                let x, y;
                
                switch(side) {
                    case 0: // ä¸Š
                        x = Math.random() * survivorGame.canvas.width;
                        y = -20;
                        break;
                    case 1: // å³
                        x = survivorGame.canvas.width + 20;
                        y = Math.random() * survivorGame.canvas.height;
                        break;
                    case 2: // ä¸‹
                        x = Math.random() * survivorGame.canvas.width;
                        y = survivorGame.canvas.height + 20;
                        break;
                    case 3: // å·¦
                        x = -20;
                        y = Math.random() * survivorGame.canvas.height;
                        break;
                }
                
                const typeIndex = Math.floor(Math.random() * survivorGame.enemyTypes.length);
                const type = survivorGame.enemyTypes[typeIndex];
                
                survivorGame.enemies.push({
                    x: x,
                    y: y,
                    ...type,
                    maxHealth: type.health,
                    lastAttack: 0
                });
            }
        }

        function updateEnemies(deltaTime) {
            survivorGame.enemies.forEach((enemy, index) => {
                // å¤„ç†å‡é€Ÿæ•ˆæœ
                if (enemy.slowEffect > 0) {
                    enemy.slowEffect -= deltaTime;
                }
                
                // ç§»åŠ¨å‘ç©å®¶
                const dx = survivorGame.player.x - enemy.x;
                const dy = survivorGame.player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance > 0) {
                    const speedModifier = enemy.slowEffect > 0 ? 0.3 : 1;
                    enemy.x += (dx / distance) * enemy.speed * speedModifier;
                    enemy.y += (dy / distance) * enemy.speed * speedModifier;
                }
                
                // æ”»å‡»ç©å®¶
                if (distance < enemy.radius + survivorGame.player.radius + 5) {
                    const now = Date.now();
                    if (now - enemy.lastAttack > 1000) {
                        survivorGame.player.health -= enemy.damage;
                        enemy.lastAttack = now;
                        
                        // å‡»é€€æ•ˆæœ
                        if (distance > 0) {
                            survivorGame.player.x += (dx / distance) * 10;
                            survivorGame.player.y += (dy / distance) * 10;
                        }
                    }
                }
                
                // ç§»é™¤è¿œç¦»çš„æ•Œäºº
                if (distance > 1000) {
                    survivorGame.enemies.splice(index, 1);
                }
            });
        }

        function updateWeapons(deltaTime) {
            const now = Date.now();
            
            survivorGame.weapons.forEach(weapon => {
                if (weapon.type === 'orbit') {
                    // æ—‹è½¬åˆ€åˆƒç‰¹æ®Šå¤„ç†
                    weapon.angle = (weapon.angle || 0) + 0.1;
                    const orbitX = survivorGame.player.x + Math.cos(weapon.angle) * weapon.range;
                    const orbitY = survivorGame.player.y + Math.sin(weapon.angle) * weapon.range;
                    
                    // æ£€æŸ¥æ˜¯å¦å‡»ä¸­æ•Œäºº
                    survivorGame.enemies.forEach((enemy, index) => {
                        const dx = orbitX - enemy.x;
                        const dy = orbitY - enemy.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < 15 && now - weapon.lastFire > weapon.cooldown) {
                            enemy.health -= weapon.damage;
                            createParticles(enemy.x, enemy.y, weapon.color);
                            weapon.lastFire = now;
                            
                            if (enemy.health <= 0) {
                                survivorGame.kills++;
                                survivorGame.score += enemy.exp * 10;
                                createExpPickup(enemy.x, enemy.y, enemy.exp);
                                survivorGame.enemies.splice(index, 1);
                            }
                        }
                    });
                    return;
                }
                
                if (now - weapon.lastFire > weapon.cooldown) {
                    if (weapon.type === 'heal') {
                        // æ²»ç–—å…‰ç¯
                        survivorGame.player.health = Math.min(
                            survivorGame.player.maxHealth,
                            survivorGame.player.health + weapon.healAmount
                        );
                        createParticles(survivorGame.player.x, survivorGame.player.y, weapon.color);
                        weapon.lastFire = now;
                        return;
                    }
                    
                    if (weapon.type === 'chain') {
                        // é›·ç”µé“¾
                        let currentTarget = null;
                        let closestDistance = weapon.range;
                        
                        survivorGame.enemies.forEach(enemy => {
                            const dx = enemy.x - survivorGame.player.x;
                            const dy = enemy.y - survivorGame.player.y;
                            const distance = Math.sqrt(dx * dx + dy * dy);
                            
                            if (distance < closestDistance) {
                                currentTarget = enemy;
                                closestDistance = distance;
                            }
                        });
                        
                        if (currentTarget) {
                            const chainTargets = [currentTarget];
                            let lastTarget = currentTarget;
                            
                            // å¯»æ‰¾è¿é”ç›®æ ‡
                            for (let i = 1; i < weapon.chainCount; i++) {
                                let nextTarget = null;
                                let nextDistance = weapon.range;
                                
                                survivorGame.enemies.forEach(enemy => {
                                    if (chainTargets.includes(enemy)) return;
                                    
                                    const dx = enemy.x - lastTarget.x;
                                    const dy = enemy.y - lastTarget.y;
                                    const distance = Math.sqrt(dx * dx + dy * dy);
                                    
                                    if (distance < nextDistance) {
                                        nextTarget = enemy;
                                        nextDistance = distance;
                                    }
                                });
                                
                                if (nextTarget) {
                                    chainTargets.push(nextTarget);
                                    lastTarget = nextTarget;
                                }
                            }
                            
                            // å¯¹æ‰€æœ‰è¿é”ç›®æ ‡é€ æˆä¼¤å®³
                            chainTargets.forEach((target, index) => {
                                setTimeout(() => {
                                    target.health -= weapon.damage;
                                    createParticles(target.x, target.y, weapon.color);
                                    
                                    if (target.health <= 0) {
                                        survivorGame.kills++;
                                        survivorGame.score += target.exp * 10;
                                        createExpPickup(target.x, target.y, target.exp);
                                        const enemyIndex = survivorGame.enemies.indexOf(target);
                                        if (enemyIndex > -1) survivorGame.enemies.splice(enemyIndex, 1);
                                    }
                                }, index * 100);
                            });
                            
                            weapon.lastFire = now;
                        }
                        return;
                    }
                    
                    // å¸¸è§„æŠ•å°„ç‰©æ­¦å™¨
                    let closestEnemy = null;
                    let closestDistance = weapon.range;
                    
                    survivorGame.enemies.forEach(enemy => {
                        const dx = enemy.x - survivorGame.player.x;
                        const dy = enemy.y - survivorGame.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < closestDistance) {
                            closestEnemy = enemy;
                            closestDistance = distance;
                        }
                    });
                    
                    if (closestEnemy) {
                        const dx = closestEnemy.x - survivorGame.player.x;
                        const dy = closestEnemy.y - survivorGame.player.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        survivorGame.projectiles.push({
                            x: survivorGame.player.x,
                            y: survivorGame.player.y,
                            vx: (dx / distance) * weapon.speed,
                            vy: (dy / distance) * weapon.speed,
                            damage: weapon.damage,
                            radius: weapon.name === 'ç«çƒæœ¯' ? 8 : 4,
                            color: weapon.color,
                            life: 1500,
                            effect: weapon.effect,
                            weaponName: weapon.name
                        });
                        
                        weapon.lastFire = now;
                    }
                }
            });
        }

        function createExpPickup(x, y, exp) {
            survivorGame.pickups.push({
                x: x,
                y: y,
                radius: 6,
                type: 'exp',
                value: exp,
                color: '#00FF00',
                life: 10000
            });
            
            // éšæœºæ‰è½è¡€åŒ…
            if (Math.random() < 0.15) {
                survivorGame.pickups.push({
                    x: x + Math.random() * 20 - 10,
                    y: y + Math.random() * 20 - 10,
                    radius: 8,
                    type: 'health',
                    value: 25,
                    color: '#FF0000',
                    life: 15000
                });
            }
        }

        function updateProjectiles(deltaTime) {
            survivorGame.projectiles.forEach((projectile, index) => {
                projectile.x += projectile.vx;
                projectile.y += projectile.vy;
                projectile.life -= deltaTime;
                
                // ç§»é™¤è¿‡æœŸå­å¼¹
                if (projectile.life <= 0 || 
                    projectile.x < 0 || projectile.x > survivorGame.canvas.width ||
                    projectile.y < 0 || projectile.y > survivorGame.canvas.height) {
                    survivorGame.projectiles.splice(index, 1);
                }
            });
        }

        function updateParticles(deltaTime) {
            survivorGame.particles.forEach((particle, index) => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                particle.life -= deltaTime;
                particle.alpha = particle.life / particle.maxLife;
                
                if (particle.life <= 0) {
                    survivorGame.particles.splice(index, 1);
                }
            });
        }

        function updatePickups(deltaTime) {
            survivorGame.pickups.forEach((pickup, index) => {
                const dx = survivorGame.player.x - pickup.x;
                const dy = survivorGame.player.y - pickup.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                // è‡ªåŠ¨å¸å–
                if (distance < 50) {
                    pickup.x += (dx / distance) * 5;
                    pickup.y += (dy / distance) * 5;
                }
                
                // æ‹¾å–
                if (distance < survivorGame.player.radius + pickup.radius) {
                    if (pickup.type === 'exp') {
                        survivorGame.player.exp += pickup.value;
                        checkLevelUp();
                    } else if (pickup.type === 'health') {
                        survivorGame.player.health = Math.min(
                            survivorGame.player.maxHealth,
                            survivorGame.player.health + pickup.value
                        );
                    }
                    
                    survivorGame.pickups.splice(index, 1);
                }
                
                pickup.life -= deltaTime;
                if (pickup.life <= 0) {
                    survivorGame.pickups.splice(index, 1);
                }
            });
        }

        function checkCollisions() {
            // å­å¼¹å‡»ä¸­æ•Œäºº
            survivorGame.projectiles.forEach((projectile, pIndex) => {
                survivorGame.enemies.forEach((enemy, eIndex) => {
                    const dx = projectile.x - enemy.x;
                    const dy = projectile.y - enemy.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < projectile.radius + enemy.radius) {
                        // ä¼¤å®³æ•Œäºº
                        enemy.health -= projectile.damage;
                        
                        // åˆ›å»ºç²’å­æ•ˆæœ
                        createParticles(enemy.x, enemy.y, enemy.color);
                        
                        // ç§»é™¤å­å¼¹
                        survivorGame.projectiles.splice(pIndex, 1);
                        
                        // æ•Œäººæ­»äº¡
                        if (enemy.health <= 0) {
                            survivorGame.kills++;
                            survivorGame.score += enemy.exp * 10;
                            
                            // çˆ†ç‚¸æ•ˆæœï¼ˆç«çƒæœ¯ï¼‰
                            if (projectile.effect === 'explosion') {
                                survivorGame.enemies.forEach(nearbyEnemy => {
                                    const dx = nearbyEnemy.x - enemy.x;
                                    const dy = nearbyEnemy.y - enemy.y;
                                    const distance = Math.sqrt(dx * dx + dy * dy);
                                    
                                    if (distance < 50 && nearbyEnemy !== enemy) {
                                        nearbyEnemy.health -= projectile.damage * 0.5;
                                        createParticles(nearbyEnemy.x, nearbyEnemy.y, '#FF4500');
                                    }
                                });
                            }
                            
                            // å‡é€Ÿæ•ˆæœï¼ˆå†°éœœç®­ï¼‰
                            if (projectile.effect === 'slow') {
                                enemy.slowEffect = 3000; // 3ç§’å‡é€Ÿ
                            }
                            
                            createExpPickup(enemy.x, enemy.y, enemy.exp);
                            survivorGame.enemies.splice(eIndex, 1);
                        } else if (projectile.effect === 'slow') {
                            // å³ä½¿æ²¡æ­»ä¹Ÿä¼šè¢«å‡é€Ÿ
                            enemy.slowEffect = 2000;
                        }
                    }
                });
            });
        }

        function createParticles(x, y, color) {
            for (let i = 0; i < 5; i++) {
                survivorGame.particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 4,
                    vy: (Math.random() - 0.5) * 4,
                    color: color,
                    radius: Math.random() * 3 + 1,
                    life: 500,
                    maxLife: 500,
                    alpha: 1
                });
            }
        }

        function checkLevelUp() {
            if (survivorGame.player.exp >= survivorGame.player.expToNext) {
                survivorGame.player.level++;
                survivorGame.player.exp -= survivorGame.player.expToNext;
                survivorGame.player.expToNext = Math.floor(survivorGame.player.expToNext * 1.5);
                
                // æ˜¾ç¤ºå‡çº§é¢æ¿
                showUpgradePanel();
            }
        }

        function showUpgradePanel() {
            survivorGame.paused = true;
            const panel = document.getElementById('upgradePanel');
            const options = document.getElementById('upgradeOptions');
            
            // è¿‡æ»¤å¯ç”¨çš„å‡çº§é€‰é¡¹
            const availableUpgrades = survivorGame.upgrades.filter(upgrade => 
                !upgrade.condition || upgrade.condition()
            );
            
            // éšæœºé€‰æ‹©3ä¸ªå‡çº§é€‰é¡¹
            const selectedUpgrades = [];
            const upgradesCopy = [...availableUpgrades];
            
            for (let i = 0; i < Math.min(3, upgradesCopy.length); i++) {
                const randomIndex = Math.floor(Math.random() * upgradesCopy.length);
                selectedUpgrades.push(upgradesCopy.splice(randomIndex, 1)[0]);
            }
            
            options.innerHTML = '';
            selectedUpgrades.forEach((upgrade, index) => {
                const option = document.createElement('div');
                option.className = 'upgrade-option';
                option.innerHTML = `
                    <div class="upgrade-title">${upgrade.name}</div>
                    <div class="upgrade-description">${upgrade.description}</div>
                `;
                option.onclick = () => {
                    upgrade.apply();
                    panel.style.display = 'none';
                    survivorGame.paused = false;
                };
                options.appendChild(option);
            });
            
            panel.style.display = 'block';
        }

        function renderGame() {
            const ctx = survivorGame.ctx;
            const canvas = survivorGame.canvas;
            
            // æ¸…ç©ºç”»å¸ƒ
            ctx.fillStyle = '#001122';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // ç»˜åˆ¶ç²’å­æ•ˆæœ
            survivorGame.particles.forEach(particle => {
                ctx.save();
                ctx.globalAlpha = particle.alpha;
                ctx.fillStyle = particle.color;
                ctx.beginPath();
                ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
            
            // ç»˜åˆ¶æ‹¾å–ç‰©
            survivorGame.pickups.forEach(pickup => {
                ctx.fillStyle = pickup.color;
                ctx.beginPath();
                ctx.arc(pickup.x, pickup.y, pickup.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // å‘å…‰æ•ˆæœ
                ctx.shadowColor = pickup.color;
                ctx.shadowBlur = 10;
                ctx.beginPath();
                ctx.arc(pickup.x, pickup.y, pickup.radius - 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });
            
            // ç»˜åˆ¶æ•Œäºº
            survivorGame.enemies.forEach(enemy => {
                ctx.fillStyle = enemy.slowEffect > 0 ? '#87CEEB' : enemy.color;
                ctx.beginPath();
                ctx.arc(enemy.x, enemy.y, enemy.radius, 0, Math.PI * 2);
                ctx.fill();
                
                // å‡é€Ÿæ•ˆæœè§†è§‰æç¤º
                if (enemy.slowEffect > 0) {
                    ctx.strokeStyle = '#87CEEB';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(enemy.x, enemy.y, enemy.radius + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // è¡€æ¡
                if (enemy.health < enemy.maxHealth) {
                    const barWidth = enemy.radius * 2;
                    const barHeight = 4;
                    const barX = enemy.x - barWidth / 2;
                    const barY = enemy.y - enemy.radius - 10;
                    
                    ctx.fillStyle = '#333';
                    ctx.fillRect(barX, barY, barWidth, barHeight);
                    
                    ctx.fillStyle = '#FF0000';
                    ctx.fillRect(barX, barY, (enemy.health / enemy.maxHealth) * barWidth, barHeight);
                }
            });
            
            // ç»˜åˆ¶æ—‹è½¬åˆ€åˆƒ
            survivorGame.weapons.forEach(weapon => {
                if (weapon.type === 'orbit') {
                    const orbitX = survivorGame.player.x + Math.cos(weapon.angle || 0) * weapon.range;
                    const orbitY = survivorGame.player.y + Math.sin(weapon.angle || 0) * weapon.range;
                    
                    ctx.fillStyle = weapon.color;
                    ctx.shadowColor = weapon.color;
                    ctx.shadowBlur = 10;
                    ctx.beginPath();
                    ctx.arc(orbitX, orbitY, 8, 0, Math.PI * 2);
                    ctx.fill();
                    ctx.shadowBlur = 0;
                }
            });
            
            // ç»˜åˆ¶å­å¼¹
            survivorGame.projectiles.forEach(projectile => {
                ctx.fillStyle = projectile.color;
                ctx.shadowColor = projectile.color;
                ctx.shadowBlur = 5;
                ctx.beginPath();
                ctx.arc(projectile.x, projectile.y, projectile.radius, 0, Math.PI * 2);
                ctx.fill();
                ctx.shadowBlur = 0;
            });
            
            // ç»˜åˆ¶ç©å®¶
            ctx.fillStyle = '#00AAFF';
            ctx.shadowColor = '#00AAFF';
            ctx.shadowBlur = 10;
            ctx.beginPath();
            ctx.arc(survivorGame.player.x, survivorGame.player.y, survivorGame.player.radius, 0, Math.PI * 2);
            ctx.fill();
            ctx.shadowBlur = 0;
            
            // æš‚åœæç¤º
            if (survivorGame.paused && !document.getElementById('upgradePanel').style.display) {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.fillStyle = '#FFFFFF';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                ctx.fillText('æ¸¸æˆæš‚åœ', canvas.width / 2, canvas.height / 2);
            }
        }

        function updateUI() {
            document.getElementById('level').textContent = survivorGame.player.level;
            document.getElementById('score').textContent = survivorGame.score;
            document.getElementById('kills').textContent = survivorGame.kills;
            
            const gameTime = Math.floor((Date.now() - survivorGame.startTime) / 1000);
            const minutes = Math.floor(gameTime / 60);
            const seconds = gameTime % 60;
            document.getElementById('time').textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            
            const healthPercent = (survivorGame.player.health / survivorGame.player.maxHealth) * 100;
            document.getElementById('healthFill').style.width = `${Math.max(0, healthPercent)}%`;
            
            const expPercent = (survivorGame.player.exp / survivorGame.player.expToNext) * 100;
            document.getElementById('expFill').style.width = `${expPercent}%`;
        }

        function gameOver() {
            survivorGame.running = false;
            const canvas = survivorGame.canvas;
            const ctx = survivorGame.ctx;
            
            ctx.fillStyle = 'rgba(0, 0, 0, 0.8)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = '#FF0000';
            ctx.font = '48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('æ¸¸æˆç»“æŸ', canvas.width / 2, canvas.height / 2 - 50);
            
            ctx.fillStyle = '#FFFFFF';
            ctx.font = '24px Arial';
            ctx.fillText(`æœ€ç»ˆåˆ†æ•°: ${survivorGame.score}`, canvas.width / 2, canvas.height / 2);
            ctx.fillText(`å‡»æ€æ•°: ${survivorGame.kills}`, canvas.width / 2, canvas.height / 2 + 30);
            ctx.fillText(`ç­‰çº§: ${survivorGame.player.level}`, canvas.width / 2, canvas.height / 2 + 60);
        }

        // è°ƒè¯•é¢æ¿åŠŸèƒ½
        function applyPlayerParams() {
            if (survivorGame.running) {
                survivorGame.player.speed = parseFloat(document.getElementById('playerSpeed').value);
                survivorGame.player.maxHealth = parseInt(document.getElementById('playerMaxHealth').value);
                if (survivorGame.player.health > survivorGame.player.maxHealth) {
                    survivorGame.player.health = survivorGame.player.maxHealth;
                }
                survivorGame.player.expToNext = parseInt(document.getElementById('expToNext').value);
            }
            console.log('ç©å®¶å‚æ•°å·²æ›´æ–°');
        }

        function applySpawnParams() {
            survivorGame.params.spawnRateBase = parseFloat(document.getElementById('spawnRateBase').value);
            survivorGame.params.spawnRateGrowth = parseFloat(document.getElementById('spawnRateGrowth').value);
            survivorGame.params.spawnRateMax = parseFloat(document.getElementById('spawnRateMax').value);
            console.log('æ•Œäººç”Ÿæˆå‚æ•°å·²æ›´æ–°');
        }

        function applyBatParams() {
            survivorGame.enemyTypes[0].health = parseInt(document.getElementById('batHealth').value);
            survivorGame.enemyTypes[0].speed = parseFloat(document.getElementById('batSpeed').value);
            survivorGame.enemyTypes[0].damage = parseInt(document.getElementById('batDamage').value);
            survivorGame.enemyTypes[0].exp = parseInt(document.getElementById('batExp').value);
            console.log('æš—å½±è™è å‚æ•°å·²æ›´æ–°');
        }

        function applySkeletonParams() {
            survivorGame.enemyTypes[1].health = parseInt(document.getElementById('skeletonHealth').value);
            survivorGame.enemyTypes[1].speed = parseFloat(document.getElementById('skeletonSpeed').value);
            survivorGame.enemyTypes[1].damage = parseInt(document.getElementById('skeletonDamage').value);
            survivorGame.enemyTypes[1].exp = parseInt(document.getElementById('skeletonExp').value);
            console.log('éª·é«…æˆ˜å£«å‚æ•°å·²æ›´æ–°');
        }

        function applyMageParams() {
            survivorGame.enemyTypes[2].health = parseInt(document.getElementById('mageHealth').value);
            survivorGame.enemyTypes[2].speed = parseFloat(document.getElementById('mageSpeed').value);
            survivorGame.enemyTypes[2].damage = parseInt(document.getElementById('mageDamage').value);
            survivorGame.enemyTypes[2].exp = parseInt(document.getElementById('mageExp').value);
            console.log('æš—é»‘æ³•å¸ˆå‚æ•°å·²æ›´æ–°');
        }

        function applyWeaponParams() {
            if (survivorGame.weapons.length > 0) {
                survivorGame.weapons[0].damage = parseInt(document.getElementById('weaponDamage').value);
                survivorGame.weapons[0].cooldown = parseInt(document.getElementById('weaponCooldown').value);
                survivorGame.weapons[0].range = parseInt(document.getElementById('weaponRange').value);
                survivorGame.weapons[0].speed = parseFloat(document.getElementById('weaponSpeed').value);
            }
            console.log('æ­¦å™¨å‚æ•°å·²æ›´æ–°');
        }

        function applyUpgradeParams() {
            survivorGame.params.damageUpgradePercent = parseInt(document.getElementById('damageUpgrade').value);
            survivorGame.params.speedUpgradePercent = parseInt(document.getElementById('speedUpgrade').value);
            survivorGame.params.healthUpgradeAmount = parseInt(document.getElementById('healthUpgrade').value);
            survivorGame.params.moveUpgradePercent = parseInt(document.getElementById('moveUpgrade').value);
            
            // æ›´æ–°å‡çº§é€‰é¡¹æè¿°
            survivorGame.upgrades[0].description = `æ­¦å™¨ä¼¤å®³ +${survivorGame.params.damageUpgradePercent}%`;
            survivorGame.upgrades[1].description = `æ”»å‡»é€Ÿåº¦ +${survivorGame.params.speedUpgradePercent}%`;
            survivorGame.upgrades[2].description = `æœ€å¤§è¡€é‡ +${survivorGame.params.healthUpgradeAmount}`;
            survivorGame.upgrades[3].description = `ç§»åŠ¨é€Ÿåº¦ +${survivorGame.params.moveUpgradePercent}%`;
            
            console.log('å‡çº§ç³»æ•°å·²æ›´æ–°');
        }

        // å¿«é€Ÿè°ƒè¯•æ¨¡å¼
        function setEasyMode() {
            document.getElementById('spawnRateBase').value = '0.002';
            document.getElementById('spawnRateGrowth').value = '0.0001';
            document.getElementById('spawnRateMax').value = '0.015';
            document.getElementById('batHealth').value = '15';
            document.getElementById('batSpeed').value = '0.6';
            document.getElementById('batDamage').value = '5';
            document.getElementById('playerSpeed').value = '2.8';
            applySpawnParams();
            applyBatParams();
            applyPlayerParams();
            console.log('å·²åˆ‡æ¢åˆ°ç®€å•æ¨¡å¼');
        }

        function setNormalMode() {
            document.getElementById('spawnRateBase').value = '0.005';
            document.getElementById('spawnRateGrowth').value = '0.0002';
            document.getElementById('spawnRateMax').value = '0.025';
            document.getElementById('batHealth').value = '25';
            document.getElementById('batSpeed').value = '1.0';
            document.getElementById('batDamage').value = '8';
            document.getElementById('playerSpeed').value = '2.2';
            applySpawnParams();
            applyBatParams();
            applyPlayerParams();
            console.log('å·²åˆ‡æ¢åˆ°æ™®é€šæ¨¡å¼');
        }

        function setHardMode() {
            document.getElementById('spawnRateBase').value = '0.01';
            document.getElementById('spawnRateGrowth').value = '0.0005';
            document.getElementById('spawnRateMax').value = '0.05';
            document.getElementById('batHealth').value = '40';
            document.getElementById('batSpeed').value = '1.5';
            document.getElementById('batDamage').value = '12';
            document.getElementById('playerSpeed').value = '1.8';
            applySpawnParams();
            applyBatParams();
            applyPlayerParams();
            console.log('å·²åˆ‡æ¢åˆ°å›°éš¾æ¨¡å¼');
        }

        function setTestMode() {
            document.getElementById('spawnRateBase').value = '0.02';
            document.getElementById('spawnRateGrowth').value = '0.001';
            document.getElementById('spawnRateMax').value = '0.1';
            document.getElementById('weaponDamage').value = '100';
            document.getElementById('weaponCooldown').value = '200';
            document.getElementById('playerSpeed').value = '5';
            document.getElementById('playerMaxHealth').value = '500';
            applySpawnParams();
            applyWeaponParams();
            applyPlayerParams();
            console.log('å·²åˆ‡æ¢åˆ°æµ‹è¯•æ¨¡å¼');
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initSurvivorGame();
            console.log('æš—å¤œå¹¸å­˜è€…å¼€å‘è°ƒè¯•ç‰ˆå·²åŠ è½½');
        });
    </script>
</body>
</html>